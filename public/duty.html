<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£ | Center City</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<nav class="navbar user-navbar">
  <div class="logo">
    <img src="/assets/logo.png" class="logo-img">
    <span>CENTER CITY</span>
  </div>

  <ul class="nav-links center-menu">
    <li><a href="/index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
    <li><a href="/duty.html" class="active">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£-‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£</a></li>
    <li><a href="/history.html">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a></li>
  </ul>
</nav>

<div class="duty-wrapper">
  <div class="duty-card">
    <h2>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ - ‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£</h2>
    <div id="clock">00:00:00</div>

    <select id="departmentSelect">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
    </select>

    <select id="nameSelect" disabled>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>
    </select>

    <button onclick="checkIn()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£</button>
    <button class="out" onclick="checkOut()">‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£</button>

    <div id="status" class="status off">üî¥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£</div>
  </div>
</div>

<script>
/* ===== CLOCK ===== */
setInterval(() => {
  document.getElementById("clock").innerText =
    new Date().toLocaleTimeString("th-TH");
}, 1000);

/* ===== ELEMENTS ===== */
const departmentSelect = document.getElementById("departmentSelect");
const nameSelect = document.getElementById("nameSelect");
const status = document.getElementById("status");

let onDuty = false;
let allUsers = [];

/* ===== LOAD USERS ===== */
fetch("/api/users")
  .then(r => r.json())
  .then(users => {
    allUsers = users;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å role
    const departments = [...new Set(users.map(u => u.role))];

    departments.forEach(dep => {
      if (!dep) return;
      const opt = document.createElement("option");
      opt.value = dep;
      opt.textContent = dep;
      departmentSelect.appendChild(opt);
    });
  });

/* ===== ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ===== */
departmentSelect.addEventListener("change", () => {
  const dep = departmentSelect.value;

  nameSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>`;

  if (!dep) {
    nameSelect.disabled = true;
    return;
  }

  const filtered = allUsers.filter(u => u.role === dep);

  filtered.forEach(u => {
    const opt = document.createElement("option");
    opt.value = u.name;
    opt.textContent = u.name;
    nameSelect.appendChild(opt);
  });

  nameSelect.disabled = false;
});

/* ===== CHECK IN ===== */
function checkIn() {
  const name = nameSelect.value;
  if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

  fetch("/api/duty/checkin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      alert(data.message);
      return;
    }

    onDuty = true;
    status.innerText = "üü¢ ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£";
    status.className = "status on";
  });
}

/* ===== CHECK OUT ===== */
function checkOut() {
  const name = nameSelect.value;
  if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

  fetch("/api/duty/checkout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      alert(data.message);
      return;
    }

    onDuty = false;
    status.innerText = "üî¥ ‡∏≠‡∏≠‡∏Å‡πÄ‡∏ß‡∏£‡πÅ‡∏•‡πâ‡∏ß";
    status.className = "status off";
  });
}
</script>

</body>
</html>
